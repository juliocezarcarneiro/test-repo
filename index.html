<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Economic Indicators Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chart-container {
      height: 500px;
      margin-bottom: 20px;
      background: white;
      border-radius: 4px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
    }
    .bg-light {
      background-color: #f8f9fa!important;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #666;
    }
    .error-message {
      color: #dc3545;
      padding: 15px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12 p-5 text-center bg-light">
        <h1>Economic Indicators Dashboard</h1>
        <p>Explore GDP, Health Spending, and Population metrics</p>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-3">
        <div class="card card-body bg-light">
          <h6>Select Year:</h6>
          <select id="yearSelect" class="form-select"></select>
        </div>
        <div class="card mt-3">
          <div class="card-header">
            <h4 class="card-title">Key Metrics</h4>
          </div>
          <div id="metrics-summary" class="card-body">
            <div class="loading">Loading data...</div>
          </div>
        </div>
      </div>
      <div class="col-md-9">
        <div class="chart-container" id="scatter-plot">
          <div class="loading">Loading scatter plot...</div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-6">
        <div class="chart-container" id="bar-chart">
          <div class="loading">Loading bar chart...</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="chart-container" id="line-chart">
          <div class="loading">Loading line chart...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    // Global variables
    let economicData = [];
    const DATA_URL = "https://juliocezarcarneiro.github.io/test-repo/Resources/countries-data.json";
    
    // Main initialization
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      loadData();
    });

    // Load and process data
    async function loadData() {
      try {
        showLoading(true);
        console.log('Fetching data from:', DATA_URL);
        
        const response = await fetch(DATA_URL);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const rawData = await response.json();
        console.log('Data loaded successfully');
        
        economicData = transformData(rawData);
        if (economicData.length === 0) {
          throw new Error('No valid data after transformation');
        }
        
        initDashboard();
      } catch (error) {
        console.error('Data loading failed:', error);
        showError(`Failed to load data: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }

    // Transform raw data to consistent format
    function transformData(rawData) {
      if (!Array.isArray(rawData)) {
        console.warn('Expected array but got:', typeof rawData);
        return [];
      }
      
      return rawData
        .map(item => {
          // Extract year (handle different date formats)
          let year;
          if (item.date) {
            const dateStr = item.date.split('T')[0]; // Handle ISO dates
            year = new Date(dateStr).getFullYear();
          } else if (item.year) {
            year = parseInt(item.year);
          }
          
          if (!year || isNaN(year)) {
            console.warn('Invalid year for item:', item);
            return null;
          }
          
          return {
            Year: year,
            Country_Name: item.country || item.Country_Name || item.name || 'Unknown',
            Country_Code: item.country_code || item.Country_Code || '',
            GDP_per_capita: parseFloat(item.gdp_per_capita || item.GDP_per_capita || item.gdp) || null,
            Health_spending_per_capita: parseFloat(item.health_expenditure || item.Health_spending_per_capita) || null,
            Population: parseInt(item.population || item.Population) || null
          };
        })
        .filter(item => item !== null && item.Country_Name !== 'Unknown');
    }

    // Initialize dashboard with data
    function initDashboard() {
      console.log('Initializing dashboard with', economicData.length, 'records');
      
      // Populate year dropdown
      const years = [...new Set(economicData.map(d => d.Year))]
        .filter(y => !isNaN(y))
        .sort((a, b) => b - a);
      
      const yearSelect = document.getElementById('yearSelect');
      yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
      
      if (years.length > 0) {
        updateDashboard(years[0]);
      } else {
        showError('No valid years found in data');
      }
      
      // Add event listener for year changes
      yearSelect.addEventListener('change', function() {
        updateDashboard(parseInt(this.value));
      });
    }

    // Update all visualizations
    function updateDashboard(selectedYear) {
      console.log('Updating dashboard for year:', selectedYear);
      
      const yearData = economicData.filter(d => d.Year === selectedYear);
      if (yearData.length === 0) {
        showError(`No data available for year ${selectedYear}`);
        return;
      }
      
      updateScatterPlot(yearData);
      updateBarChart(yearData);
      updateLineChart(yearData);
      updateMetricsSummary(yearData);
    }

    // 1. Scatter Plot: GDP vs Health Spending
    function updateScatterPlot(data) {
      const container = document.getElementById('scatter-plot');
      const filteredData = data.filter(d => 
        d.GDP_per_capita && 
        d.Health_spending_per_capita && 
        d.Country_Name
      );
      
      if (filteredData.length === 0) {
        container.innerHTML = '<div class="error-message">No GDP and Health Spending data available</div>';
        return;
      }

      const trace = {
        x: filteredData.map(d => d.GDP_per_capita),
        y: filteredData.map(d => d.Health_spending_per_capita),
        text: filteredData.map(d => d.Country_Name),
        mode: 'markers',
        type: 'scatter',
        marker: {
          size: 10,
          color: filteredData.map(d => d.Population ? Math.log10(d.Population) : 1),
          colorscale: 'Viridis',
          opacity: 0.8,
          colorbar: {
            title: 'Log10(Population)'
          }
        },
        hovertemplate: '<b>%{text}</b><br>GDP: $%{x:,.0f}<br>Health: $%{y:,.0f}<extra></extra>'
      };
      
      Plotly.newPlot(container, [trace], {
        title: `GDP vs Health Spending (${data[0].Year})`,
        xaxis: { title: 'GDP per Capita (USD)', type: 'log' },
        yaxis: { title: 'Health Spending per Capita (USD)', type: 'log' },
        margin: { t: 50, l: 60, r: 30, b: 60 }
      });
    }

    // 2. Bar Chart: Top Countries by GDP
    function updateBarChart(data) {
      const container = document.getElementById('bar-chart');
      const filteredData = data
        .filter(d => d.GDP_per_capita && d.Country_Name)
        .sort((a, b) => b.GDP_per_capita - a.GDP_per_capita)
        .slice(0, 15);
      
      if (filteredData.length === 0) {
        container.innerHTML = '<div class="error-message">No GDP data available</div>';
        return;
      }

      Plotly.newPlot(container, [{
        x: filteredData.map(d => d.Country_Name),
        y: filteredData.map(d => d.GDP_per_capita),
        type: 'bar',
        marker: {
          color: filteredData.map(d => {
            if (d.GDP_per_capita > 30000) return '#2ca02c';
            if (d.GDP_per_capita > 10000) return '#ff7f0e';
            return '#d62728';
          })
        },
        hovertemplate: '<b>%{x}</b><br>GDP: $%{y:,.0f}<extra></extra>'
      }], {
        title: `Top 15 Countries by GDP (${data[0].Year})`,
        xaxis: { title: 'Country', tickangle: -45 },
        yaxis: { title: 'GDP per Capita (USD)' },
        margin: { t: 50, l: 60, r: 30, b: 100 }
      });
    }

    // 3. Line Chart: GDP Trends for Top Countries
    function updateLineChart(yearData) {
      const container = document.getElementById('line-chart');
      const topCountries = yearData
        .filter(d => d.GDP_per_capita && d.Country_Name)
        .sort((a, b) => b.GDP_per_capita - a.GDP_per_capita)
        .slice(0, 5)
        .map(d => d.Country_Name);
      
      if (topCountries.length === 0) {
        container.innerHTML = '<div class="error-message">No GDP data for trends</div>';
        return;
      }

      const traces = topCountries.map(country => {
        const countryData = economicData
          .filter(d => d.Country_Name === country && d.GDP_per_capita)
          .sort((a, b) => a.Year - b.Year);
        
        return {
          x: countryData.map(d => d.Year),
          y: countryData.map(d => d.GDP_per_capita),
          name: country,
          type: 'line',
          hovertemplate: '<b>%{text}</b><br>Year: %{x}<br>GDP: $%{y:,.0f}<extra></extra>'
        };
      });

      Plotly.newPlot(container, traces, {
        title: `GDP Trends for Top Countries (${yearData[0].Year})`,
        xaxis: { title: 'Year' },
        yaxis: { title: 'GDP per Capita (USD)' },
        margin: { t: 50, l: 60, r: 30, b: 60 },
        legend: { orientation: 'h', y: -0.2 }
      });
    }

    // Update metrics summary panel
    function updateMetricsSummary(data) {
      const summaryDiv = document.getElementById('metrics-summary');
      
      const withGDP = data.filter(d => d.GDP_per_capita);
      const withHealth = data.filter(d => d.Health_spending_per_capita);
      const withPop = data.filter(d => d.Population);
      
      const avgGDP = withGDP.reduce((sum, d) => sum + d.GDP_per_capita, 0) / withGDP.length;
      const avgHealth = withHealth.reduce((sum, d) => sum + d.Health_spending_per_capita, 0) / withHealth.length;
      const totalPop = withPop.reduce((sum, d) => sum + d.Population, 0);
      
      summaryDiv.innerHTML = `
        <p><strong>Countries:</strong> ${data.length}</p>
        <p><strong>Avg GDP:</strong> $${avgGDP.toLocaleString('en-US', {maximumFractionDigits: 0})}</p>
        <p><strong>Avg Health Spending:</strong> $${avgHealth.toLocaleString('en-US', {maximumFractionDigits: 0})}</p>
        <p><strong>Total Population:</strong> ${totalPop.toLocaleString('en-US')}</p>
      `;
    }

    // UI Helpers
    function showLoading(show) {
      document.querySelectorAll('.loading').forEach(el => {
        el.style.display = show ? 'flex' : 'none';
      });
    }

    function showError(message) {
      console.error('Dashboard error:', message);
      document.querySelectorAll('.chart-container').forEach(container => {
        if (container.innerHTML.includes('Loading')) {
          container.innerHTML = `<div class="error-message">${message}</div>`;
        }
      });
    }
  </script>
</body>
</html>