<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>GDP and Health Spending Analysis</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
    }
    #bubble, #line {
      height: 600px;
    }
    .chart-container {
      margin-bottom: 30px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12 p-5 text-center bg-light">
        <h1>Global Economic Indicators</h1>
        <p>Explore the relationship between GDP per capita and health spending across countries</p>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4>GDP vs Health Spending per Capita</h4>
          </div>
          <div class="card-body">
            <div id="bubble"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4>Top 10 Countries by GDP per Capita</h4>
          </div>
          <div class="card-body">
            <div id="line"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12 text-center">
        <p class="text-muted">Data source: World Bank Indicators</p>
      </div>
    </div>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  
  <script>
    // Initialize the page
    function init() {
      buildBubbleChart();
    }

    // Build the bubble chart
    function buildBubbleChart() {
      const dataUrl = "Resources/countries-data.json";
      const backupUrl = "https://raw.githubusercontent.com/plotly/datasets/master/gapminderDataFiveYear.json";
    
      // Load the data
      d3.json(dataUrl)
        .then((data) => {
          console.log("Raw data sample:", data.slice(0, 10));
          // Filter out entries with missing data
          data = data.filter(d => d.GDP_per_capita && d.Health_spending_per_capita);
          renderCharts(data);
        })
        .catch(error => {
          console.warn("Primary data failed, trying backup...", error);
          d3.json(backupUrl)
            .then(transformBackupData)
            .then(data => {
              renderCharts(data);
            })
            .catch(backupError => {
              console.error("Both data sources failed:", backupError);
              showError(backupError);
            });
        });

      // Function to transform backup data if primary fails
      function transformBackupData(backupData) {
        console.log("Using backup data with transformation");
        return backupData.map(d => ({
          "Country Name": d.country,
          "GDP_per_capita": d.gdpPercap,
          "Health_spending_per_capita": d.lifeExp * 100
        }));
      }

      // Function to render both charts
      function renderCharts(data) {
        renderBubbleChart(data);
        renderLineChart(data);
      }

      // Function to render the bubble chart
      function renderBubbleChart(data) {
        let countries = data.map(d => d["Country Name"]);
        let gdp = data.map(d => d.GDP_per_capita);
        let health = data.map(d => d.Health_spending_per_capita);

        // Bubble chart data
        let bubbleData = [{
          x: gdp,
          y: health,
          text: countries.map((c, i) => 
            `<b>${c}</b><br>` +
            `GDP per capita: $${gdp[i]?.toLocaleString() || 'N/A'}<br>` +
            `Health spending: $${health[i]?.toLocaleString() || 'N/A'}`
          ),
          mode: 'markers',
          marker: {
            size: health.map(h => Math.sqrt(h) * 3),
            sizemode: 'area',
            sizeref: 0.1,
            color: gdp,
            colorscale: 'Viridis',
            opacity: 0.7,
            line: {
              width: 1,
              color: '#333'
            },
            colorbar: {
              title: 'GDP per Capita',
              tickprefix: '$'
            }
          },
          type: 'scatter',
          hoverinfo: 'text',
          hoverlabel: {
            bgcolor: 'white',
            font: {
              family: 'Arial',
              size: 12,
              color: 'black'
            }
          }
        }];

        // Layout configuration
        const bubbleLayout = {
          title: {
            text: 'GDP per Capita vs Health Spending per Capita',
            font: {
              size: 18,
              family: 'Arial'
            }
          },
          xaxis: {
            title: {
              text: 'GDP per Capita (USD) - Log Scale',
              font: {
                size: 14
              }
            },
            type: 'log',
            gridcolor: '#eee',
            zeroline: false,
            tickprefix: '$',
            tickformat: ',.0f'
          },
          yaxis: {
            title: {
              text: 'Health Spending per Capita (USD) - Log Scale',
              font: {
                size: 14
              }
            },
            type: 'log',
            gridcolor: '#eee',
            zeroline: false,
            tickprefix: '$',
            tickformat: ',.0f'
          },
          hovermode: 'closest',
          margin: { t: 80, l: 80, r: 80, b: 80 },
          height: 550,
          plot_bgcolor: 'rgba(240,240,240,0.8)',
          paper_bgcolor: 'rgba(240,240,240,0.3)'
        };

        // Render the chart
        Plotly.newPlot("bubble", bubbleData, bubbleLayout);
      }

      // Function to render the line chart
      function renderLineChart(data) {
        // First, properly convert all GDP values to numbers
        const processedData = data.map(d => {
          let gdpValue;
          
          // Handle scientific notation (like "1.20E+05")
          if (typeof d.GDP_per_capita === 'string' && d.GDP_per_capita.includes('E')) {
            gdpValue = parseFloat(d.GDP_per_capita);
          } 
          // Handle regular number strings
          else if (typeof d.GDP_per_capita === 'string') {
            gdpValue = parseFloat(d.GDP_per_capita.replace(/[^0-9.-]/g, ''));
          }
          // Already a number
          else {
            gdpValue = d.GDP_per_capita;
          }
          
          return {
            ...d,
            GDP_per_capita: gdpValue
          };
        }).filter(d => {
          // Filter out invalid entries
          return !isNaN(d.GDP_per_capita) && 
                 d.GDP_per_capita > 0 && 
                 d["Country Name"] && 
                 d["Country Name"].trim() !== "";
        });

        // Sort data by GDP per capita (descending) and take top 10
        const sortedData = [...processedData]
          .sort((a, b) => b.GDP_per_capita - a.GDP_per_capita)
          .slice(0, 10);
        
        const countries = sortedData.map(d => d["Country Name"]);
        const gdpValues = sortedData.map(d => d.GDP_per_capita);
        
        // Line chart data
        const lineData = [{
          x: countries,
          y: gdpValues,
          type: 'scatter',
          mode: 'lines+markers+text',
          line: {
            color: '#0d6efd',
            width: 3,
            shape: 'spline',
            smoothing: 1.3
          },
          marker: {
            size: 10,
            color: '#0d6efd',
            line: {
              width: 2,
              color: 'white'
            }
          },
          text: gdpValues.map(v => `$${Math.round(v).toLocaleString()}`),
          textposition: 'top center',
          textfont: {
            size: 12,
            color: 'black'
          },
          hoverinfo: 'text',
          hovertext: countries.map((c, i) => 
            `<b>${c}</b><br>GDP per capita: $${gdpValues[i].toLocaleString()}`
          )
        }];
        
        // Line chart layout
        const lineLayout = {
          title: {
            text: 'Top 10 Countries by GDP per Capita',
            font: {
              size: 18,
              family: 'Arial'
            }
          },
          xaxis: {
            title: {
              text: 'Country',
              font: {
                size: 14
              }
            },
            tickangle: -45,
            tickfont: {
              size: 12
            },
            automargin: true
          },
          yaxis: {
            title: {
              text: 'GDP per Capita (USD)',
              font: {
                size: 14
              }
            },
            tickprefix: '$',
            gridcolor: '#eee',
            zeroline: false,
            range: [0, Math.max(...gdpValues) * 1.2]
          },
          margin: { 
            t: 80,
            l: 80, 
            r: 80, 
            b: 150
          },
          height: 600,
          plot_bgcolor: 'rgba(240,240,240,0.8)',
          paper_bgcolor: 'rgba(240,240,240,0.3)',
          hovermode: 'closest'
        };
        
        // Render the line chart
        Plotly.newPlot("line", lineData, lineLayout);
      }

      // Function to show error message
      function showError(error) {
        console.error("Error loading the data: ", error);
        d3.select("#bubble").html(`
          <div class="alert alert-danger mt-4">
            <h4>Error Loading Data</h4>
            <p>${error.message}</p>
            <p>Attempted URLs:</p>
            <ul>
              <li>${dataUrl}</li>
              <li>${backupUrl}</li>
            </ul>
            <p>Please check your internet connection or try again later.</p>
          </div>
        `);
      }
    }

    // Call init when the page loads
    window.onload = init;
  </script>
  
  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>