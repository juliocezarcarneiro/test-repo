<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Economic Indicators Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 1rem;
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .dashboard-header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 2rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
    }
    .card {
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: white;
      border: none;
      margin-bottom: 2rem;
      height: 100%;
    }
    .card-title {
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 1.5rem;
      font-size: 1.2rem;
    }
    .chart-container {
      height: 400px; /* Fixed height for all charts */
      width: 100%;
    }
    .small-chart-container {
      height: 300px; /* Slightly smaller for insight cards */
      width: 100%;
    }
    .insight-card {
      transition: all 0.3s ease;
      height: 100%;
    }
    .insight-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .controls-card {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
    }
    .section-title {
      color: #2c3e50;
      font-weight: 600;
      margin: 2rem 0 1rem;
      border-bottom: 2px solid #3498db;
      padding-bottom: 0.5rem;
    }
    .form-label {
      font-weight: 500;
      color: #2c3e50;
    }
    .card-footer {
      background: transparent;
      border-top: none;
      padding: 1rem 0 0;
      font-size: 0.9rem;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="dashboard-header text-center">
      <h1>Global Economic Indicators Dashboard</h1>
      <p class="lead">Exploring the relationship between wealth, health spending, and population density</p>
    </div>

    <!-- Controls -->
    <div class="controls-card">
      <div class="row">
        <div class="col-md-6">
          <label for="yearSelect" class="form-label">Select Year:</label>
          <select id="yearSelect" class="form-select"></select>
        </div>
      </div>
    </div>

    <!-- Key Insights Section -->
    <h2 class="section-title">Key Insights</h2>
    <div class="row">
      <div class="col-md-4">
        <div class="card insight-card">
          <div class="card-title">Wealthiest Nations</div>
          <div class="small-chart-container" id="topGDPChart"></div>
          <div class="card-footer">Top 3 countries by GDP per capita</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card insight-card">
          <div class="card-title">Most Densely Populated</div>
          <div class="small-chart-container" id="topDensityChart"></div>
          <div class="card-footer">Top 3 countries by population density</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card insight-card">
          <div class="card-title">Highest Health Spenders</div>
          <div class="small-chart-container" id="topHealthChart"></div>
          <div class="card-footer">Top 3 countries by health expenditure</div>
        </div>
      </div>
    </div>

    <!-- Economic Trends Section -->
    <h2 class="section-title">Economic Trends Over Time</h2>
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-title">Global GDP per Capita Over Time</div>
          <div class="chart-container" id="lineGDP"></div>
          <div class="card-footer">Shows the global average GDP per capita trend</div>
        </div>
      </div>
    </div>

    <!-- Comparative Analysis Section -->
    <h2 class="section-title">Comparative Analysis</h2>
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-title">GDP vs. Population Density</div>
          <div class="chart-container" id="barGDPvsDensity"></div>
          <div class="card-footer">Relationship between wealth and population concentration</div>
        </div>
      </div>
      <div class="col-md-12">
        <div class="card">
          <div class="card-title">GDP vs. Population Density with Health Spending</div>
          <div class="chart-container" id="bubbleGDPvsDensity"></div>
          <div class="card-footer">Bubble size represents health expenditure per capita</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <script>
    const dataURL = "https://juliocezarcarneiro.github.io/test-repo/Resources/countries-data.json";
    let allData;
    let selectedYear = "2000";  // Default to the first year
  
    // Color scheme
    const colors = {
      gdp: '#3498db',
      density: '#e74c3c',
      health: '#2ecc71',
      background: '#f8f9fa'
    };

    // Enhanced margin configuration
    const marginSettings = {
      small: { t: 40, b: 60, l: 60, r: 20, pad: 0 },
      large: { t: 40, b: 80, l: 80, r: 30, pad: 0 }
    };

    // Fetching data from the URL
    d3.json(dataURL).then(data => {
      if (data) {
        console.log("Data successfully loaded:", data);
        allData = data;
        populateYearDropdown(data);
        updateAllCharts();
      } else {
        console.error("No data received from the URL.");
      }
    }).catch(err => {
      console.error("Error fetching data:", err);
    });
  
    function populateYearDropdown(data) {
      const years = [...new Set(data.map(d => d.Year))].sort();
      const yearSelect = d3.select("#yearSelect");
  
      years.forEach(year => {
        yearSelect.append("option").text(year).attr("value", year);
      });
      yearSelect.property("value", selectedYear);
  
      yearSelect.on("change", function () {
        selectedYear = this.value;
        updateAllCharts();
      });
    }
  
    function filterData() {
      return allData.filter(d => 
        d.Year == selectedYear &&
        d["GDP per Capita"] !== "No data" &&
        d["Health_Expenditure"] !== "No data" && 
        d["Population density per square kilometer"] !== "No data"
      );
    }
  
    function updateAllCharts() {
      const yearData = filterData();
      if (yearData.length > 0) {
        drawLineGDPChart();
        drawBarGDPvsDensityChart(yearData);
        drawBubbleGDPvsDensityChart(yearData);
        drawMiniCharts(yearData);
      } else {
        console.warn("No data available for the selected year.");
      }
    }
  
    function drawMiniCharts(data) {
      // GDP Chart
      const topGDP = data.sort((a, b) => b["GDP per Capita"] - a["GDP per Capita"]).slice(0, 3);
      Plotly.newPlot("topGDPChart", [{
        x: topGDP.map(d => d.Country),
        y: topGDP.map(d => d["GDP per Capita"]),
        type: 'bar',
        marker: { color: colors.gdp }
      }], {
        margin: marginSettings.small,
        yaxis: { title: 'USD' },
        xaxis: { automargin: true }
      }, { responsive: true });

      // Density Chart
      const topDensity = data.sort((a, b) => b["Population density per square kilometer"] - a["Population density per square kilometer"]).slice(0, 3);
      Plotly.newPlot("topDensityChart", [{
        x: topDensity.map(d => d.Country),
        y: topDensity.map(d => d["Population density per square kilometer"]),
        type: 'bar',
        marker: { color: colors.density }
      }], {
        margin: marginSettings.small,
        yaxis: { title: 'People/kmÂ²' },
        xaxis: { automargin: true }
      }, { responsive: true });

      // Health Chart
      const topHealth = data.sort((a, b) => b["Health_Expenditure"] - a["Health_Expenditure"]).slice(0, 3);
      Plotly.newPlot("topHealthChart", [{
        x: topHealth.map(d => d.Country),
        y: topHealth.map(d => d["Health_Expenditure"]),
        type: 'bar',
        marker: { color: colors.health }
      }], {
        margin: marginSettings.small,
        yaxis: { title: 'USD' },
        xaxis: { automargin: true }
      }, { responsive: true });
    }
  
    function drawLineGDPChart() {
      const grouped = d3.rollup(allData, v => d3.mean(v, d => d["GDP per Capita"]), d => d.Year);
      const years = Array.from(grouped.keys()).sort();
      const values = years.map(year => grouped.get(year));
  
      Plotly.newPlot("lineGDP", [{
        x: years,
        y: values,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: colors.gdp, width: 3 },
        marker: { size: 8 }
      }], {
        margin: marginSettings.large,
        xaxis: { title: 'Year' },
        yaxis: { title: 'GDP per Capita (USD)' },
        plot_bgcolor: colors.background
      }, { responsive: true });
    }
  
    function drawBarGDPvsDensityChart(data) {
      // Sort by GDP and take top 15 for better readability
      const topCountries = data.sort((a, b) => b["GDP per Capita"] - a["GDP per Capita"]).slice(0, 15);
  
      Plotly.newPlot("barGDPvsDensity", [{
        x: topCountries.map(d => d.Country),
        y: topCountries.map(d => d["GDP per Capita"]),
        type: 'bar',
        marker: { color: colors.gdp }
      }], {
        margin: { ...marginSettings.large, b: 100 }, // Extra bottom margin for x-axis labels
        xaxis: { 
          title: 'Country',
          tickangle: -45,
          automargin: true
        },
        yaxis: { title: 'GDP per Capita (USD)' },
        plot_bgcolor: colors.background
      }, { responsive: true });
    }
  
    function drawBubbleGDPvsDensityChart(data) {
      Plotly.newPlot("bubbleGDPvsDensity", [{
        x: data.map(d => d["Population density per square kilometer"]),
        y: data.map(d => d["GDP per Capita"]),
        text: data.map(d => `${d.Country}<br>GDP: $${d["GDP per Capita"]}<br>Density: ${d["Population density per square kilometer"]} people/kmÂ²`),
        mode: 'markers',
        marker: {
          size: data.map(d => Math.sqrt(d["Health_Expenditure"]) * 0.8), // Adjusted size multiplier
          color: colors.health,
          opacity: 0.7,
          sizemode: 'area',
          sizeref: 0.1,
          sizemin: 4
        }
      }], {
        margin: marginSettings.large,
        xaxis: { title: 'Population Density (people/kmÂ²)' },
        yaxis: { title: 'GDP per Capita (USD)' },
        hoverlabel: { bgcolor: '#fff' },
        plot_bgcolor: colors.background
      }, { responsive: true });
    }
  </script>
</body>
</html>