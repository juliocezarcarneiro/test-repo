<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>GDP and Health Spending Analysis</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
    }
    #bubble, #bar {
      height: 600px;
    }
    .chart-container {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12 p-5 text-center bg-light">
        <h1>Global Economic Indicators</h1>
        <p>Explore the relationship between GDP per capita and health spending across countries</p>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4>GDP vs Health Spending per Capita</h4>
          </div>
          <div class="card-body">
            <div id="bubble"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4>Top 10 Countries by GDP per Capita</h4>
          </div>
          <div class="card-body">
            <div id="bar"></div>  <!-- Changed from "line" to "bar" -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12 text-center">
        <p class="text-muted">Data source: World Bank Indicators</p>
      </div>
    </div>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <script>
    function init() {
      buildBubbleChart();
    }

    function buildBubbleChart() {
      const dataUrl = "Resources/countries-data.json";
      const backupUrl = "https://raw.githubusercontent.com/plotly/datasets/master/gapminderDataFiveYear.json";

      d3.json(dataUrl)
        .then(data => {
          console.log("Loaded data:", data); // Debugging
          data = cleanData(data);
          console.log("Cleaned data:", data); // Debugging
          renderCharts(data);
        })
        .catch(error => {
          console.warn("Primary data failed, trying backup...", error);
          d3.json(backupUrl)
            .then(transformBackupData)
            .then(data => {
              console.log("Using backup data:", data); // Debugging
              renderCharts(data);
            })
            .catch(backupError => showError(backupError));
        });

      function transformBackupData(backupData) {
        // Get unique countries from backup data
        const uniqueCountries = [...new Set(backupData.map(item => item.country))];
        
        // For each country, get the most recent data point
        const recentData = uniqueCountries.map(country => {
          const countryData = backupData.filter(d => d.country === country);
          return countryData[countryData.length - 1]; // Get most recent entry
        });
        
        return recentData.map(d => ({
          "Country Name": d.country,
          "GDP_per_capita": d.gdpPercap,
          "Health_spending_per_capita": d.lifeExp * 100 // approximate
        }));
      }

      function cleanData(data) {
        return data
          .map(d => {
            let gdp = typeof d.GDP_per_capita === 'string'
              ? parseFloat(d.GDP_per_capita.replace(/[^0-9.eE+-]/g, ''))
              : d.GDP_per_capita;

            let health = typeof d.Health_spending_per_capita === 'string'
              ? parseFloat(d.Health_spending_per_capita.replace(/[^0-9.eE+-]/g, ''))
              : d.Health_spending_per_capita;

            return {
              ...d,
              GDP_per_capita: gdp,
              Health_spending_per_capita: health
            };
          })
          .filter(d => !isNaN(d.GDP_per_capita) && d.GDP_per_capita > 0 && 
                       !isNaN(d.Health_spending_per_capita) && d.Health_spending_per_capita > 0);
      }

      function renderCharts(data) {
        console.log("Rendering charts with data:", data); // Debugging
        if (data && data.length > 0) {
          renderBubbleChart(data);
          renderBarChart(data);
        } else {
          showError(new Error("No valid data available to render charts"));
        }
      }

      function renderBubbleChart(data) {
        let bubbleData = [{
          x: data.map(d => d.GDP_per_capita),
          y: data.map(d => d.Health_spending_per_capita),
          text: data.map(d =>
            `<b>${d["Country Name"]}</b><br>GDP: $${d.GDP_per_capita.toLocaleString()}<br>Health Spending: $${d.Health_spending_per_capita.toLocaleString()}`),
          mode: 'markers',
          marker: {
            size: data.map(d => Math.sqrt(d.Health_spending_per_capita) * 3),
            sizemode: 'area',
            sizeref: 0.1,
            color: data.map(d => d.GDP_per_capita),
            colorscale: 'Viridis',
            opacity: 0.7,
            line: { width: 1, color: '#333' },
            colorbar: {
              title: 'GDP per Capita',
              tickprefix: '$'
            }
          },
          type: 'scatter',
          hoverinfo: 'text',
          hoverlabel: {
            bgcolor: 'white',
            font: { family: 'Arial', size: 12, color: 'black' }
          }
        }];

        const layout = {
          title: 'GDP per Capita vs Health Spending per Capita',
          xaxis: {
            title: 'GDP per Capita (USD) - Log Scale',
            type: 'log',
            gridcolor: '#eee',
            tickprefix: '$'
          },
          yaxis: {
            title: 'Health Spending per Capita (USD) - Log Scale',
            type: 'log',
            gridcolor: '#eee',
            tickprefix: '$'
          },
          margin: { t: 80, l: 80, r: 80, b: 80 },
          plot_bgcolor: 'rgba(240,240,240,0.8)',
          paper_bgcolor: 'rgba(240,240,240,0.3)',
          height: 550,
          hovermode: 'closest'
        };

        Plotly.newPlot("bubble", bubbleData, layout);
      }

      function renderBarChart(data) {
        // Ensure we have at least 10 countries, but no more than available
        const count = Math.min(10, data.length);
        const sorted = [...data].sort((a, b) => b.GDP_per_capita - a.GDP_per_capita).slice(0, count);
        const countries = sorted.map(d => d["Country Name"]);
        const gdpValues = sorted.map(d => d.GDP_per_capita);

        const barData = [{
          x: countries,
          y: gdpValues,
          type: 'bar',
          marker: {
            color: '#0d6efd'
          },
          text: gdpValues.map(v => `$${Math.round(v).toLocaleString()}`),
          textposition: 'auto',
          hovertext: countries.map((c, i) => `<b>${c}</b><br>GDP per capita: $${gdpValues[i].toLocaleString()}`),
          hoverinfo: 'text'
        }];

        const layout = {
          title: `Top ${count} Countries by GDP per Capita`,
          xaxis: {
            title: 'Country',
            tickangle: -45,
            automargin: true
          },
          yaxis: {
            title: 'GDP per Capita (USD)',
            tickprefix: '$',
            gridcolor: '#eee',
            zeroline: false,
            range: [0, Math.max(...gdpValues) * 1.2]
          },
          margin: { t: 80, l: 80, r: 80, b: 150 },
          height: 600,
          plot_bgcolor: 'rgba(240,240,240,0.8)',
          paper_bgcolor: 'rgba(240,240,240,0.3)',
          hovermode: 'closest'
        };

        Plotly.newPlot("bar", barData, layout);
      }

      function showError(error) {
        console.error("Error loading the data: ", error);
        const errorHtml = `
          <div class="alert alert-danger mt-4">
            <h4>Error Loading Data</h4>
            <p>${error.message || 'Unknown error occurred'}</p>
            <p>Please check your internet connection or try again later.</p>
          </div>
        `;
        document.getElementById("bubble").innerHTML = errorHtml;
        document.getElementById("bar").innerHTML = errorHtml;
      }
    }

    window.onload = init;
  </script>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>