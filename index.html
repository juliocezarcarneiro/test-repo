<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Economic Indicators Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chart-container { height: 500px; margin-bottom: 20px; }
    .card-header { background-color: #0d6efd; color: white; }
    .loading { display: flex; justify-content: center; align-items: center; height: 100%; }
    .error-message { color: #dc3545; padding: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row p-5 text-center bg-light">
      <h1>Economic Indicators Dashboard</h1>
      <p>Explore economic metrics across countries</p>
    </div>
    <div class="row mt-3">
      <div class="col-md-3">
        <div class="card card-body bg-light">
          <h6>Select Year:</h6>
          <select id="yearSelect" class="form-select"></select>
        </div>
        <div class="card mt-3">
          <div class="card-header"><h4>Key Metrics</h4></div>
          <div id="metrics-summary" class="card-body"></div>
        </div>
      </div>
      <div class="col-md-9">
        <div class="chart-container" id="scatter-plot"></div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-6">
        <div class="chart-container" id="bar-chart"></div>
      </div>
      <div class="col-md-6">
        <div class="chart-container" id="line-chart"></div>
      </div>
    </div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    const DATA_URL = "https://juliocezarcarneiro.github.io/test-repo/Resources/countries-data.json";
    let economicData = [];

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      try {
        showLoading(true);
        const rawData = await loadData();
        economicData = transformData(rawData);
        if (economicData.length === 0) throw new Error('No valid data after transformation.');
        initDashboard();
      } catch (error) {
        console.error('Initialization failed:', error);
        showError(`Failed to initialize: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }

    async function loadData() {
      const response = await fetch(DATA_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      return data;
    }

    function transformData(rawData) {
      if (!Array.isArray(rawData)) return [];

      const transformed = [];
      const skipped = [];

      rawData.forEach((item, index) => {
        try {
          const year = parseInt(item.Year);
          if (!year || isNaN(year)) throw new Error(`Invalid year in record ${index}`);

          const country = item.Country;
          if (!country) throw new Error(`Missing country in record ${index}`);

          const gdp = parseNumber(item["GDP per Capita"]);
          const health = parseNumber(item["Health_Expenditure"]);
          const popDensity = parseNumber(item["Population density per square kilometer"]);

          transformed.push({
            Year: year,
            Country_Name: country,
            Country_Code: item.Code || '',
            GDP_per_capita: gdp,
            Health_spending_per_capita: health,
            Population: popDensity // We're using population density as a proxy here
          });
        } catch (error) {
          skipped.push({ index, error: error.message });
        }
      });

      return transformed;
    }

    function parseNumber(value) {
      if (value === undefined || value === null || value === "No data") return null;
      const num = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : Number(value);
      return isNaN(num) ? null : num;
    }

    function initDashboard() {
      const years = [...new Set(economicData.map(d => d.Year))]
        .filter(y => !isNaN(y))
        .sort((a, b) => b - a);

      const yearSelect = document.getElementById('yearSelect');
      yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
      yearSelect.addEventListener('change', () => updateDashboard(parseInt(yearSelect.value)));

      updateDashboard(years[0]);
    }

    function updateDashboard(year) {
      const yearData = economicData.filter(d => d.Year === year);
      updateScatterPlot(yearData, year);
      updateBarChart(yearData, year);
      updateLineChart(year);
      updateMetricsSummary(yearData);
    }

    function updateScatterPlot(data, year) {
      const validData = data.filter(d => d.GDP_per_capita && d.Health_spending_per_capita);

      if (validData.length === 0) {
        document.getElementById('scatter-plot').innerHTML =
          '<div class="error-message">No GDP/Health data for selected year</div>';
        return;
      }

      Plotly.newPlot('scatter-plot', [{
        x: validData.map(d => d.GDP_per_capita),
        y: validData.map(d => d.Health_spending_per_capita),
        text: validData.map(d => d.Country_Name),
        mode: 'markers',
        marker: {
          size: 10,
          color: validData.map(d => d.Population || 1),
          colorscale: 'Viridis',
          opacity: 0.7
        }
      }], {
        title: `GDP vs Health Spending (${year})`,
        xaxis: { title: 'GDP per Capita (USD)', type: 'log' },
        yaxis: { title: 'Health Spending per Capita (USD)', type: 'log' }
      });
    }

    function updateBarChart(data, year) {
      const validData = data.filter(d => d.GDP_per_capita)
        .sort((a, b) => b.GDP_per_capita - a.GDP_per_capita)
        .slice(0, 15);

      if (validData.length === 0) {
        document.getElementById('bar-chart').innerHTML =
          '<div class="error-message">No GDP data for selected year</div>';
        return;
      }

      Plotly.newPlot('bar-chart', [{
        x: validData.map(d => d.Country_Name),
        y: validData.map(d => d.GDP_per_capita),
        type: 'bar'
      }], {
        title: `Top Countries by GDP (${year})`,
        xaxis: { tickangle: -45 }
      });
    }

    function updateLineChart(year) {
      const yearData = economicData.filter(d => d.Year === year);
      const topCountries = yearData
        .filter(d => d.GDP_per_capita)
        .sort((a, b) => b.GDP_per_capita - a.GDP_per_capita)
        .slice(0, 5)
        .map(d => d.Country_Name);

      if (topCountries.length === 0) {
        document.getElementById('line-chart').innerHTML =
          '<div class="error-message">No GDP trend data available</div>';
        return;
      }

      const traces = topCountries.map(country => {
        const countryData = economicData
          .filter(d => d.Country_Name === country && d.GDP_per_capita)
          .sort((a, b) => a.Year - b.Year);

        return {
          x: countryData.map(d => d.Year),
          y: countryData.map(d => d.GDP_per_capita),
          name: country,
          type: 'line'
        };
      });

      Plotly.newPlot('line-chart', traces, {
        title: `GDP Trends for Top Countries (${year})`
      });
    }

    function updateMetricsSummary(data) {
      const metrics = {
        'Countries': data.length,
        'Avg GDP': calculateAverage(data, 'GDP_per_capita'),
        'Avg Health': calculateAverage(data, 'Health_spending_per_capita'),
        'Avg Pop Density': calculateAverage(data, 'Population')
      };

      document.getElementById('metrics-summary').innerHTML =
        Object.entries(metrics).map(([name, value]) =>
          `<p><strong>${name}:</strong> ${formatValue(name, value)}</p>`
        ).join('');
    }

    function calculateAverage(data, field) {
      const values = data.map(d => d[field]).filter(v => v !== null);
      return values.length ? values.reduce((a, b) => a + b, 0) / values.length : null;
    }

    function formatValue(name, value) {
      if (value === null) return 'N/A';
      if (name.includes('GDP') || name.includes('Health')) return `$${Math.round(value).toLocaleString()}`;
      if (name.includes('Pop')) return `${Math.round(value).toLocaleString()} per kmÂ²`;
      return value;
    }

    function showLoading(show) {
      document.querySelectorAll('.chart-container').forEach(el => {
        el.innerHTML = show ? '<div class="loading">Loading...</div>' : '';
      });
    }

    function showError(message) {
      document.querySelectorAll('.chart-container').forEach(el => {
        el.innerHTML = `<div class="error-message">${message}</div>`;
      });
    }
  </script>
</body>
</html>
