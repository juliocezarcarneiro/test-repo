<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Economic Indicators Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { 
      background-color: #f8f9fa; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 20px;
    }
    .card { 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
      margin-bottom: 20px; 
      border-radius: 10px; 
      border: none;
    }
    .card-header { 
      background-color: #0d6efd; 
      color: white; 
      border-radius: 10px 10px 0 0 !important; 
      padding: 12px 20px;
    }
    .chart-container { 
      height: 500px; 
      margin-bottom: 20px; 
      background: white; 
      border-radius: 0 0 10px 10px; 
      padding: 15px;
    }
    .loading { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100%;
      font-size: 1.1rem;
      color: #666;
    }
    .filter-container { 
      background: white; 
      padding: 15px; 
      border-radius: 10px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .form-label {
      font-weight: 500;
      margin-bottom: 8px;
    }
    .form-select {
      border-radius: 5px;
      padding: 8px 12px;
    }
    .header-section {
      background-color: #f8f9fa !important;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 20px;
    }
    @media (max-width: 768px) {
      .chart-container {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center header-section">
        <h2>Economic Indicators Analysis</h2>
        <p class="lead">Visualizing GDP, Health Spending and Income Inequality</p>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="filter-container">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Year:</label>
              <select id="yearSelect" class="form-select">
                <!-- Populated by JavaScript -->
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Map Metric:</label>
              <select id="metricSelect" class="form-select">
                <option value="GDP_per_capita">GDP per Capita</option>
                <option value="Health_spending_per_capita">Health Spending</option>
                <option value="GINI_index">Income Inequality (GINI)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Global Indicators Map</h5>
          </div>
          <div id="geo-map" class="chart-container">
            <div class="loading">
              <div class="spinner-border text-primary" role="status"></div>
              <span>Loading map...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>GDP vs Health Spending</h5>
          </div>
          <div id="bubble" class="chart-container">
            <div class="loading">
              <div class="spinner-border text-primary" role="status"></div>
              <span>Loading chart...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Top Health Spenders</h5>
          </div>
          <div id="bar" class="chart-container">
            <div class="loading">
              <div class="spinner-border text-primary" role="status"></div>
              <span>Loading chart...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Main initialization function
    function init() {
      // Show loading state
      document.querySelectorAll('.loading').forEach(el => {
        el.innerHTML = `
          <div class="spinner-border text-primary" role="status"></div>
          <span>Loading data...</span>
        `;
      });

      // Load data from JSON file
      d3.json("https://juliocezarcarneiro.github.io/test-repo/Resources/countries-data.json")
        .then(data => {
          if (!data || !Array.isArray(data)) {
            throw new Error("Invalid data format received");
          }

          // Process and visualize the data
          processDataAndVisualize(data);
        })
        .catch(err => {
          console.error("Error loading data:", err);
          showError(err.message || "Failed to load data");
        });
    }

    // Process data and set up visualizations
    function processDataAndVisualize(data) {
      // Get available years and sort descending
      const years = [...new Set(data.map(d => d.Year))]
        .filter(y => y !== undefined && y !== null)
        .sort((a, b) => b - a);

      if (years.length === 0) {
        throw new Error("No valid years found in data");
      }

      // Set up year dropdown
      const yearSelect = document.getElementById("yearSelect");
      yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

      // Set up event listeners for filters
      const updateVisualizations = () => {
        const selectedYear = +yearSelect.value;
        const selectedMetric = document.getElementById("metricSelect").value;
        updateAllCharts(data, selectedYear, selectedMetric);
      };

      yearSelect.addEventListener("change", updateVisualizations);
      document.getElementById("metricSelect").addEventListener("change", updateVisualizations);

      // Initial visualization with first available year
      updateVisualizations();
    }

    // Update all charts based on selected filters
    function updateAllCharts(data, year, metric) {
      try {
        // Filter data for selected year
        const yearData = data.filter(d => d.Year === year);
        
        // Update each visualization
        updateMap(yearData, metric);
        updateBubbleChart(yearData);
        updateBarChart(yearData);
      } catch (error) {
        console.error("Error updating charts:", error);
        showError(error.message || "Error updating visualizations");
      }
    }

    // Update the choropleth map
    function updateMap(data, metric) {
      const container = document.getElementById("geo-map");
      
      // Filter valid data points
      const validData = data.filter(d => 
        d[metric] !== undefined && 
        d[metric] !== null && 
        d["Country Code"] && 
        d["Country Name"]
      );

      if (validData.length === 0) {
        container.innerHTML = `
          <div class="alert alert-warning">
            No data available for the selected metric and year
          </div>
        `;
        return;
      }

      // Configuration for different metrics
      const metricConfig = {
        GDP_per_capita: {
          title: "GDP per Capita (USD)",
          colorscale: [
            [0, '#E3F2FD'], [0.2, '#90CAF9'], [0.4, '#42A5F5'],
            [0.6, '#1E88E5'], [0.8, '#1565C0'], [1, '#0D47A1']
          ],
          zmin: 500,
          zmax: 50000,
          hoverTemplate: "<b>%{location}</b><br>GDP: $%{z:,.0f}"
        },
        Health_spending_per_capita: {
          title: "Health Spending per Capita (USD)",
          colorscale: [
            [0, '#E8F5E9'], [0.2, '#A5D6A7'], [0.4, '#66BB6A'],
            [0.6, '#43A047'], [0.8, '#2E7D32'], [1, '#1B5E20']
          ],
          zmin: 50,
          zmax: 5000,
          hoverTemplate: "<b>%{location}</b><br>Health Spending: $%{z:,.0f}"
        },
        GINI_index: {
          title: "Income Inequality (GINI Index)",
          colorscale: [
            [0, '#4CAF50'], [0.3, '#8BC34A'], [0.5, '#FFC107'],
            [0.7, '#FF9800'], [1, '#F44336']
          ],
          zmin: 20,
          zmax: 70,
          hoverTemplate: "<b>%{location}</b><br>GINI Index: %{z:.1f}"
        }
      };

      const config = metricConfig[metric];

      // Create the choropleth trace
      const trace = {
        type: 'choropleth',
        locationmode: 'ISO-3',
        locations: validData.map(d => d["Country Code"]),
        z: validData.map(d => d[metric]),
        text: validData.map(d => d["Country Name"]),
        hoverinfo: 'text+z',
        hovertemplate: config.hoverTemplate,
        colorscale: config.colorscale,
        zmin: config.zmin,
        zmax: config.zmax,
        autocolorscale: false,
        reversescale: metric === 'GINI_index',
        marker: {
          line: {
            color: 'rgb(220,220,220)',
            width: 0.7
          }
        },
        colorbar: {
          title: config.title,
          thickness: 20,
          tickprefix: metric === 'GINI_index' ? '' : '$',
          ticksuffix: metric === 'GINI_index' ? '' : '',
          tickformat: metric === 'GINI_index' ? '.1f' : ',.0f'
        }
      };

      // Map layout configuration
      const layout = {
        title: {
          text: `${config.title} (${data[0].Year})`,
          font: {
            size: 16,
            family: 'Arial, sans-serif'
          }
        },
        geo: {
          showframe: false,
          showcoastlines: true,
          projection: {
            type: 'natural earth',
            scale: 1.2
          },
          bgcolor: 'rgba(0,0,0,0)',
          landcolor: 'rgb(245,245,245)',
          subunitcolor: 'rgb(220,220,220)'
        },
        margin: {
          t: 50,
          l: 0,
          r: 0,
          b: 0
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
      };

      // Plot the map
      Plotly.newPlot(container, [trace], layout, {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['toImage', 'sendDataToCloud'],
        scrollZoom: false
      });
    }

    // Update the bubble chart (GDP vs Health Spending)
    function updateBubbleChart(data) {
      const container = document.getElementById("bubble");
      
      // Filter data points with both GDP and Health Spending
      const validData = data.filter(d => 
        d.GDP_per_capita && 
        d.Health_spending_per_capita && 
        d["Country Name"]
      );

      if (validData.length === 0) {
        container.innerHTML = `
          <div class="alert alert-warning">
            No GDP and Health Spending data available for the selected year
          </div>
        `;
        return;
      }

      // Adjust visual parameters based on data size
      const sizeMultiplier = validData.length < 5 ? 3 : 1.5;
      const showTextLabels = validData.length <= 10;

      // Create bubble chart trace
      const trace = {
        x: validData.map(d => d.GDP_per_capita),
        y: validData.map(d => d.Health_spending_per_capita),
        text: validData.map(d => `
          <b>${d["Country Name"]}</b><br>
          GDP: $${formatNumber(d.GDP_per_capita)}<br>
          Health Spending: $${formatNumber(d.Health_spending_per_capita)}<br>
          ${d.GINI_index ? `GINI: ${d.GINI_index.toFixed(1)}` : ''}
        `),
        mode: showTextLabels ? 'markers+text' : 'markers',
        type: 'scatter',
        hoverinfo: 'text',
        marker: {
          size: validData.map(d => Math.sqrt(d.Health_spending_per_capita) * sizeMultiplier),
          sizemode: 'area',
          sizeref: 0.05,
          color: '#4285F4',
          opacity: 0.8,
          line: {
            width: 1,
            color: 'rgba(0,0,0,0.3)'
          }
        },
        textposition: 'top center',
        textfont: {
          size: 10,
          color: '#333'
        }
      };

      // Bubble chart layout
      const layout = {
        title: {
          text: `GDP vs Health Spending (${data[0].Year})`,
          font: {
            size: 16
          }
        },
        xaxis: {
          title: 'GDP per Capita (USD, log scale)',
          type: 'log',
          tickformat: '$,.0f',
          gridcolor: 'rgba(0,0,0,0.1)',
          range: [Math.log10(500), Math.log10(50000)]
        },
        yaxis: {
          title: 'Health Spending per Capita (USD, log scale)',
          type: 'log',
          tickformat: '$,.0f',
          gridcolor: 'rgba(0,0,0,0.1)',
          range: [Math.log10(50), Math.log10(5000)]
        },
        hovermode: 'closest',
        margin: {
          t: 50,
          l: 60,
          r: 30,
          b: 60
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
      };

      // Plot the bubble chart
      Plotly.newPlot(container, [trace], layout, {
        responsive: true,
        displayModeBar: true
      });
    }

    // Update the bar chart (Top Health Spenders)
    function updateBarChart(data) {
      const container = document.getElementById("bar");
      
      // Filter and sort health spending data
      const healthSpenders = data
        .filter(d => d.Health_spending_per_capita && d["Country Name"])
        .sort((a, b) => b.Health_spending_per_capita - a.Health_spending_per_capita);

      // Show all if less than 10, otherwise top 10
      const displayData = healthSpenders.slice(0, Math.max(3, healthSpenders.length));

      if (displayData.length === 0) {
        container.innerHTML = `
          <div class="alert alert-warning">
            No health spending data available for the selected year
          </div>
        `;
        return;
      }

      // Use distinct colors for small datasets
      const colors = displayData.length <= 3 ? 
        ['#4285F4', '#34A853', '#EA4335'] : // Google colors for 3 or fewer
        '#4285F4'; // Default blue for more

      // Create bar chart trace
      const trace = {
        x: displayData.map(d => d["Country Name"]),
        y: displayData.map(d => d.Health_spending_per_capita),
        type: 'bar',
        text: displayData.map(d => `$${formatNumber(d.Health_spending_per_capita)}`),
        textposition: 'auto',
        hoverinfo: 'text',
        hovertext: displayData.map(d => `
          <b>${d["Country Name"]}</b><br>
          Health Spending: $${formatNumber(d.Health_spending_per_capita)}<br>
          GDP: $${formatNumber(d.GDP_per_capita || 'N/A')}<br>
          ${d.GINI_index ? `GINI: ${d.GINI_index.toFixed(1)}` : ''}
        `),
        marker: {
          color: colors,
          line: {
            width: 1,
            color: 'rgba(0,0,0,0.2)'
          }
        }
      };

      // Bar chart layout
      const layout = {
        title: {
          text: `Top Health Spenders (${data[0].Year})`,
          font: {
            size: 16
          }
        },
        xaxis: {
          title: 'Country',
          tickangle: -45,
          tickfont: {
            size: 10
          }
        },
        yaxis: {
          title: 'Health Spending per Capita (USD)',
          tickformat: '$,.0f',
          gridcolor: 'rgba(0,0,0,0.1)'
        },
        margin: {
          t: 50,
          l: 60,
          r: 30,
          b: Math.max(80, displayData.length * 20) // Dynamic bottom margin
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)'
      };

      // Plot the bar chart
      Plotly.newPlot(container, [trace], layout, {
        responsive: true,
        displayModeBar: true
      });
    }

    // Helper function to format numbers
    function formatNumber(num) {
      if (num === undefined || num === null) return 'N/A';
      return Math.round(num).toLocaleString();
    }

    // Show error message
    function showError(message) {
      document.querySelectorAll('.chart-container').forEach(el => {
        el.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            ${message}
          </div>
        `;
      });
    }

    // Initialize when DOM is loaded
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>